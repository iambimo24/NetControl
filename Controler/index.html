<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controller — 接收端</title>
  <style>body{font-family:sans-serif;margin:16px}video{width:640px;height:480px;background:#000}</style>
</head>
<body>
  <h3>Controller (接收端)</h3>
  <p>输入一个 id 并连接信令服务器以接收来自被控端的视频流（通过 WebRTC DataChannel 发送的 JPEG 帧）。</p>
  <label>ID: <input id="id" value="controller1"></label>
  <button id="connect">连接信令</button>
  <div>
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>

  <script>
    const wsUrlBase = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.hostname}:8081/ws`;
    let pc, ws, remoteDC;

    document.getElementById('connect').onclick = async () => {
      const id = document.getElementById('id').value || 'controller1';
      ws = new WebSocket(wsUrlBase + `?id=${encodeURIComponent(id)}&role=controller`);

      ws.onopen = () => console.log('信令已连接');
      ws.onmessage = async (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === 'offer') {
          await ensurePeer();
          const sdp = new RTCSessionDescription({type: 'offer', sdp: msg.payload});
          await pc.setRemoteDescription(sdp);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({type: 'answer', from: id, to: msg.from, payload: answer.sdp}));
        } else if (msg.type === 'candidate') {
          if (pc) {
            try { await pc.addIceCandidate(JSON.parse(msg.payload)); } catch (e) { console.warn(e); }
          }
        }
      };

      ws.onclose = () => console.log('信令已断开');
    };

    async function ensurePeer() {
      if (pc) return;
      pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});

      pc.onicecandidate = (e) => {
        if (e.candidate && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({type:'candidate', payload: JSON.stringify(e.candidate)}));
        }
      };

      pc.ondatachannel = (ev) => {
        remoteDC = ev.channel;
        console.log('收到 DataChannel', remoteDC.label);
        setupDataChannel(remoteDC);
      };
    }

    function setupDataChannel(dc) {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      let blobParts = [];
      dc.onmessage = (ev) => {
        // 我们假设发送端按帧发送完整的 JPEG 二进制数据
        const data = ev.data;
        if (data instanceof ArrayBuffer) {
          const blob = new Blob([data], {type: 'image/jpeg'});
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            URL.revokeObjectURL(url);
          };
          img.src = url;
        } else if (typeof data === 'string') {
          // 可用于接收文本控制消息
          console.log('text msg', data);
        }
      };

      dc.onopen = () => console.log('DataChannel open');
      dc.onclose = () => console.log('DataChannel close');
    }
  </script>
</body>
</html>
